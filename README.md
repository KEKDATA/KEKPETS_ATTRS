# О задаче

Код в этом репозитории решает задачу тренировки нейронной сети для определения оттенка шерсти собак и длины их хвостов.
Оттенок шерсти разделяется по следующим классам:
    1. `dark` - темный окрас шерсти;
    2. `bright` - светлый окрас шерсти;
    3. `ginger` - рыжий окрас шерсти;
    4. `multicolor` - окрас шерсти содержит несколько цветов.
Длина хвоста животного:
    1. `long` - длинный хвост;
    2. `short` - короткий хвост.
    
# О данных
Данные содержат в себе информацию об оттенке шерсти собак и о длине их хвостов.

### Формирование набора данных
Набор данных для этой модели был подготовлен следующим образом:
    1. Из исходных изображений были вырезаны собаки;
    2. Кропы, полученные на предыдущем шаге, были вручную классифицированы на категории по цвету и по длине хвоста.

### Цвет шерсти
Изначально было дано три оттенка цвета шерсти: темный, светлый и мультицвет. Мы выделили дополнительно рыжий оттенок в отдельный класс, так как разметка была очень плохой и рыжий оттенок находился во всех трех изначальных классах.
Итоговое множество цветов животного:
    1. `dark` - темный окрас шерсти;
    2. `bright` - светлый окрас шерсти;
    3. `ginger` - рыжий окрас шерсти;
    4. `multicolor` - окрас шерсти содержит несколько цветов.
    
### Длины хвостов
Данные, полученные от организаторов, содержат огромное число ошибок. Поэтому мы переразметили кропы вручную.

# Организация репозитория

 - Ноутбук `create_csv.ipynb` содержит в себе код подготовки .csv файла для процесса тренировки модели;
 - Модуль `dataset/animal.py` содержит в себе код для работы с Pytorch-датасетом;
 - Модуль `model/animal.py` содержит в себе код модели для решения поставленной задачи;
 - Модуль `utils/augmentation.py` содержит в себе вспомогательные функции для аугментации данных;
 - Модуль `utils/config.py` содержит в себе вспомогательные функции для конфигурации проекта;
 - Модуль `utils/data.py` содержит в себе вспомогательные функции для работы с данными;
 - Модуль `utils/ema.py` содержит в себе код экспоненциально скользящего среднего;
 - Модуль `utils/general.py` содержит в себе общие вспомогательные функции;
 - Модуль `utils/training.py` содержит в себе функции процесса тренировки;
 - Модуль `utils/validation.py` содержит в себе функции оценки качества модели;
 - Модуль `train.py` является точкой запуска процесса тренировки модели.
 - Файл `config.yml` является конфигурационном файлом, в котором находятся все настройки проекта.
 - Файл `export_to_onnx.py` содержит в себе код перевода модели в формат `ONNX` и оптимизацию производительности модели.
__Каждый модуль и каждая функция снабжены документ-строками, подробно объясняющими, для чего функция или модуль предназначены. Аналогично конфигурационный файл содержит в себе комментарии к каждому из параметров конфигурации.__

# Требования для запуска проекта
Проект рассчитан на работу с `python3.8`. Зависимости, необходимые для запуска проекта, указаны в файле `requirements.txt`.

# Как подготовить свой набор данных для обучения?
Вам необходимо собрать фотографии собак, на которых будет виден цвет шерсти собаки и ее хвост. После того, как фотографии собак будут собраны, вам необходимо создать `.csv` файл с путями до этих фотографий и метками классов. Пример такого файла вы можете найти в `example_csv/train.csv`.

# Запуск проекта
1. Склонируйте себе этот репозиторий и перейдите в него.
2. Создайте свежее виртуальное окружение и активируйте его:  [инструкция](https://docs.python.org/3/library/venv.html);
3. Установите необходимые зависимости: `pip install -r requirements.txt`;
4. Воспользуйтесь [ClearML](https://clear.ml/docs/latest/docs/);
5. Измените файл `config.yml`, выставив желаемые вами настройки;
6. Запустите файл `train.py`.
Файл с весами лучшей модели появится в директории `outputs/`.
После получения файла модели переведите ее в формат `ONNX` следующей командой:
`python export_to_onnx.py -i %path_to_weights% -o %path_to_onnx_model% -s 224,224`
__Замечание__: Модель после процедуры оптимизации начинает работать очень быстро без потери качества, поэтому рекомендуем воспользоваться процедурой оптимизации модели.